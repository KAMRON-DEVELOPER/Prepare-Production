services:
  fastapi:
    image: kamronbekdev/fastapi:v1.0
    #    ports:
    #      - "8000:8000"
    networks:
      - traefik-public
    secrets:
      - db_url
      - redis_url
    environment:
      DB_URL: /run/secrets/db_url
      REDIS_URL: /run/secrets/redis_url
    deploy:
      replicas: 4
      labels:
        - "prometheus-job=fastapi"
        - "traefik.enable=true"
        - "traefik.http.routers.fastapi_router.rule=Host(`api.kronk.uz`)"
        - "traefik.http.routers.fastapi_router.entrypoints=http,https"
        - "traefik.http.routers.fastapi_router.tls.certresolver=leresolver"
        - "traefik.http.routers.fastapi_router.service=fastapi_service"
        - "traefik.http.services.fastapi_service.loadbalancer.server.port=8000" # in swarm mode we must define explicitly
        - "traefik.http.middlewares.fastapi_middleware.redirectscheme.scheme=https"
        # - "traefik.http.routers.fastapi_router.middlewares=fastapi_middleware"
        - "traefik.http.middlewares.fastapi_middleware.redirectscheme.permanent=true"
        - "traefik.http.services.fastapi_service.loadbalancer.healthcheck.hostname=api.kronk.uz" # optional
        - "traefik.http.services.fastapi_service.loadbalancer.healthcheck.path=/healthy" # required
        - "traefik.http.services.fastapi_service.loadbalancer.healthcheck.interval=60s" # default: 30s
        # - "traefik.http.routers.fastapi_router.tls=true"
        # - "traefik.http.routers.fastapi_router.tls.certresolver=leresolver"
      resources:
        limits:
          cpus: 1
          memory: 512M
      update_config:
        order: stop-first
        parallelism: 1

networks:
  traefik-public:
    external: true
    driver: overlay

secrets:
  db_url:
    external: true
  redis_url:
    external: true
